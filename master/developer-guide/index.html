<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/node-feature-discovery/master/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/node-feature-discovery/master/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li:not(:nth-child(5)) > a, .site-nav > ul.nav-list:first-child > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(5) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(5) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(5) > ul.nav-list { display: block; } </style> <script src="/node-feature-discovery/master/assets/js/vendor/lunr.min.js"></script> <script src="/node-feature-discovery/master/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Developer guide | Node Feature Discovery</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="Developer guide" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Documentation of Node Feature Discovery - a Kubernetes add-on for discovering and advertising hardware features and system configuration in the cluster." /> <meta property="og:description" content="Documentation of Node Feature Discovery - a Kubernetes add-on for discovering and advertising hardware features and system configuration in the cluster." /> <link rel="canonical" href="https://kubernetes-sigs.github.com/node-feature-discovery/master/developer-guide/" /> <meta property="og:url" content="https://kubernetes-sigs.github.com/node-feature-discovery/master/developer-guide/" /> <meta property="og:site_name" content="Node Feature Discovery" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Developer guide" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Documentation of Node Feature Discovery - a Kubernetes add-on for discovering and advertising hardware features and system configuration in the cluster.","headline":"Developer guide","url":"https://kubernetes-sigs.github.com/node-feature-discovery/master/developer-guide/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/node-feature-discovery/master/" class="site-title lh-tight"> Node Feature Discovery </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Get started category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/node-feature-discovery/master/get-started/" class="nav-list-link">Get started</a><ul class="nav-list"><li class="nav-list-item"><a href="/node-feature-discovery/master/get-started/introduction.html" class="nav-list-link">Introduction</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/get-started/quick-start.html" class="nav-list-link">Quick start</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Deployment category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/node-feature-discovery/master/deployment/" class="nav-list-link">Deployment</a><ul class="nav-list"><li class="nav-list-item"><a href="/node-feature-discovery/master/deployment/image-variants.html" class="nav-list-link">Image variants</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/deployment/kustomize.html" class="nav-list-link">Kustomize</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/deployment/helm.html" class="nav-list-link">Helm</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/deployment/operator.html" class="nav-list-link">NFD Operator</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/deployment/uninstallation.html" class="nav-list-link">Uninstallation</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/deployment/metrics.html" class="nav-list-link">Metrics</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Usage category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/node-feature-discovery/master/usage/" class="nav-list-link">Usage</a><ul class="nav-list"><li class="nav-list-item"><a href="/node-feature-discovery/master/usage/features.html" class="nav-list-link">Feature labels</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/usage/using-labels.html" class="nav-list-link">Using node labels</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/usage/nfd-master.html" class="nav-list-link">NFD-Master</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/usage/nfd-worker.html" class="nav-list-link">NFD-Worker</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/usage/nfd-topology-updater.html" class="nav-list-link">NFD-Topology-Updater</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/usage/nfd-gc.html" class="nav-list-link">NFD-Garbage-Collector</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/usage/custom-resources.html" class="nav-list-link">CRDs</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/usage/customization-guide.html" class="nav-list-link">Customization guide</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/usage/examples-and-demos.html" class="nav-list-link">Examples and demos</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/usage/kubectl-plugin.html" class="nav-list-link">Kubectl plugin</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/usage/image-compatibility.html" class="nav-list-link">Image Compatibility Artifact</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Reference category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/node-feature-discovery/master/reference/" class="nav-list-link">Reference</a><ul class="nav-list"><li class="nav-list-item"><a href="/node-feature-discovery/master/reference/master-commandline-reference.html" class="nav-list-link">Master cmdline reference</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/reference/worker-commandline-reference.html" class="nav-list-link">Worker cmdline reference</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/reference/master-configuration-reference.html" class="nav-list-link">Master config reference</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/reference/worker-configuration-reference.html" class="nav-list-link">Worker config reference</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/reference/topology-updater-commandline-reference.html" class="nav-list-link">Topology Updater Cmdline Reference</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/reference/topology-updater-configuration-reference.html" class="nav-list-link">Topology-Updater config reference</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/reference/gc-commandline-reference.html" class="nav-list-link">Garbage Collector Cmdline Reference</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/reference/plugin-commandline-reference.html" class="nav-list-link">Kubectl plugin cmdline reference</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/reference/node-feature-client-reference.html" class="nav-list-link">Node Feature client cmdline reference</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/reference/versions.html" class="nav-list-link">Versions</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/reference/feature-gates.html" class="nav-list-link">Feature Gates</a></li></ul></li><li class="nav-list-item"><a href="/node-feature-discovery/master/developer-guide/" class="nav-list-link">Developer guide</a></li><li class="nav-list-item"><a href="/node-feature-discovery/master/contributing/" class="nav-list-link">Contributing</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Node Feature Discovery" aria-label="Search Node Feature Discovery" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <div class="version-dropdown"> <label for="versions">Version:</label> <select id="versions" onchange="location = this.value;"> <script src="/node-feature-discovery/versions.js"></script> <script> var select = document.getElementById('versions'); var items = getVersionListItems(); for (var i=0; i < items.length; i++) { var opt = document.createElement('option'); opt.appendChild(document.createTextNode(items[i].name)); opt.value = items[i].url; select.appendChild(opt); } </script> </select> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 class="no_toc" id="developer-guide"> <a href="#developer-guide" class="anchor-heading" aria-labelledby="developer-guide"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developer guide </h1> <h2 class="no_toc text-delta" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents </h2> <ol id="markdown-toc"> <li><a href="#building-from-source" id="markdown-toc-building-from-source">Building from source</a> <ol> <li><a href="#download-the-source-code" id="markdown-toc-download-the-source-code">Download the source code</a></li> <li><a href="#docker-build" id="markdown-toc-docker-build">Docker build</a></li> <li><a href="#docker-multi-arch-builds-with-buildx" id="markdown-toc-docker-multi-arch-builds-with-buildx">Docker multi-arch builds with buildx</a></li> <li><a href="#deployment" id="markdown-toc-deployment">Deployment</a></li> <li><a href="#building-locally" id="markdown-toc-building-locally">Building locally</a></li> <li><a href="#customizing-the-build" id="markdown-toc-customizing-the-build">Customizing the build</a></li> <li><a href="#testing" id="markdown-toc-testing">Testing</a></li> <li><a href="#nfd-master" id="markdown-toc-nfd-master">NFD-Master</a></li> <li><a href="#nfd-worker" id="markdown-toc-nfd-worker">NFD-Worker</a></li> <li><a href="#nfd-topology-updater" id="markdown-toc-nfd-topology-updater">NFD-Topology-Updater</a></li> </ol> </li> <li><a href="#running-with-tilt" id="markdown-toc-running-with-tilt">Running with Tilt</a> <ol> <li><a href="#prerequisites" id="markdown-toc-prerequisites">Prerequisites</a></li> <li><a href="#environment-variables" id="markdown-toc-environment-variables">Environment variables</a></li> </ol> </li> <li><a href="#documentation" id="markdown-toc-documentation">Documentation</a></li> </ol><hr /> <h2 id="building-from-source"> <a href="#building-from-source" class="anchor-heading" aria-labelledby="building-from-source"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Building from source </h2> <h3 id="download-the-source-code"> <a href="#download-the-source-code" class="anchor-heading" aria-labelledby="download-the-source-code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Download the source code </h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/kubernetes-sigs/node-feature-discovery
<span class="nb">cd </span>node-feature-discovery
</code></pre></div></div> <h3 id="docker-build"> <a href="#docker-build" class="anchor-heading" aria-labelledby="docker-build"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Docker build </h3> <h4 id="build-the-container-image"> <a href="#build-the-container-image" class="anchor-heading" aria-labelledby="build-the-container-image"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build the container image </h4> <p>See <a href="#customizing-the-build">customizing the build</a> below for altering the container image registry, for example.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
</code></pre></div></div> <h4 id="push-the-container-image"> <a href="#push-the-container-image" class="anchor-heading" aria-labelledby="push-the-container-image"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Push the container image </h4> <p>Optional, this example with Docker.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push &lt;IMAGE_TAG&gt;
</code></pre></div></div> <h3 id="docker-multi-arch-builds-with-buildx"> <a href="#docker-multi-arch-builds-with-buildx" class="anchor-heading" aria-labelledby="docker-multi-arch-builds-with-buildx"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Docker multi-arch builds with buildx </h3> <p>The default set of architectures enabled for mulit-arch builds are <code class="language-plaintext highlighter-rouge">linux/amd64</code> and <code class="language-plaintext highlighter-rouge">linux/arm64</code>. If more architectures are needed one can override the <code class="language-plaintext highlighter-rouge">IMAGE_ALL_PLATFORMS</code> variable with a comma separated list of <code class="language-plaintext highlighter-rouge">OS/ARCH</code> tuples.</p> <h4 id="build-the-manifest-list-with-a-container-image-per-arch"> <a href="#build-the-manifest-list-with-a-container-image-per-arch" class="anchor-heading" aria-labelledby="build-the-manifest-list-with-a-container-image-per-arch"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Build the manifest-list with a container image per arch </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make image-all
</code></pre></div></div> <p>Currently <code class="language-plaintext highlighter-rouge">docker</code> does not support loading of manifest-lists meaning the images are not shown when executing <code class="language-plaintext highlighter-rouge">docker images</code>, see: <a href="https://github.com/docker/buildx/issues/59">buildx issue #59</a>.</p> <h4 id="push-the-manifest-list-with-container-image-per-arch"> <a href="#push-the-manifest-list-with-container-image-per-arch" class="anchor-heading" aria-labelledby="push-the-manifest-list-with-container-image-per-arch"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Push the manifest-list with container image per arch </h4> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make push-all
</code></pre></div></div> <p>The resulting container image can be used in the same way on each arch by pulling e.g. <code class="language-plaintext highlighter-rouge">node-feature-discovery:master</code> without specifying the architecture. The manifest-list will take care of providing the right architecture image.</p> <h4 id="change-the-job-spec-to-use-your-custom-image-optional"> <a href="#change-the-job-spec-to-use-your-custom-image-optional" class="anchor-heading" aria-labelledby="change-the-job-spec-to-use-your-custom-image-optional"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Change the job spec to use your custom image (optional) </h4> <p>To use your published image from the step above instead of the <code class="language-plaintext highlighter-rouge">registry.k8s.io/nfd/node-feature-discovery</code> image, edit <code class="language-plaintext highlighter-rouge">image</code> attribute in the spec template(s) to the new location (<code class="language-plaintext highlighter-rouge">&lt;registry-name&gt;/&lt;image-name&gt;[:&lt;version&gt;]</code>).</p> <h3 id="deployment"> <a href="#deployment" class="anchor-heading" aria-labelledby="deployment"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deployment </h3> <p>The <code class="language-plaintext highlighter-rouge">yamls</code> makefile generates a <code class="language-plaintext highlighter-rouge">kustomization.yaml</code> matching your locally built image and using the <code class="language-plaintext highlighter-rouge">deploy/overlays/default</code> deployment. See <a href="#customizing-the-build">build customization</a> below for configurability, e.g. changing the deployment namespace.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">K8S_NAMESPACE</span><span class="o">=</span>my-ns make yamls
kubectl apply <span class="nt">-k</span> <span class="nb">.</span>
</code></pre></div></div> <p>You can use alternative deployment methods by modifying the auto-generated kustomization file.</p> <h3 id="building-locally"> <a href="#building-locally" class="anchor-heading" aria-labelledby="building-locally"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Building locally </h3> <p>You can also build the binaries locally</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make build
</code></pre></div></div> <p>This will compile binaries under <code class="language-plaintext highlighter-rouge">bin/</code></p> <h3 id="customizing-the-build"> <a href="#customizing-the-build" class="anchor-heading" aria-labelledby="customizing-the-build"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Customizing the build </h3> <p>There are several Makefile variables that control the build process and the name of the resulting container image. The following are targeted targeted for build customization and they can be specified via environment variables or makefile overrides.</p> <div class="table-wrapper"><table> <thead> <tr> <th>Variable</th> <th>Description</th> <th>Default value</th> </tr> </thead> <tbody> <tr> <td>HOSTMOUNT_PREFIX</td> <td>Prefix of system directories for feature discovery (local builds)</td> <td>/ (<em>local builds</em>) /host- (<em>container builds</em>)</td> </tr> <tr> <td>IMAGE_BUILD_CMD</td> <td>Command to build the image</td> <td>docker build</td> </tr> <tr> <td>IMAGE_BUILD_EXTRA_OPTS</td> <td>Extra options to pass to build command</td> <td><em>empty</em></td> </tr> <tr> <td>IMAGE_BUILDX_CMD</td> <td>Command to build and push multi-arch images with buildx</td> <td>DOCKER_CLI_EXPERIMENTAL=enabled docker buildx build –platform=${IMAGE_ALL_PLATFORMS} –progress=auto –pull</td> </tr> <tr> <td>IMAGE_ALL_PLATFORMS</td> <td>Comma separated list of OS/ARCH tuples for mulit-arch builds</td> <td>linux/amd64,linux/arm64</td> </tr> <tr> <td>IMAGE_PUSH_CMD</td> <td>Command to push the image to remote registry</td> <td>docker push</td> </tr> <tr> <td>IMAGE_REGISTRY</td> <td>Container image registry to use</td> <td>registry.k8s.io/nfd</td> </tr> <tr> <td>IMAGE_TAG_NAME</td> <td>Container image tag name</td> <td>&lt;nfd version&gt;</td> </tr> <tr> <td>IMAGE_EXTRA_TAG_NAMES</td> <td>Additional container image tag(s) to create when building image</td> <td><em>empty</em></td> </tr> <tr> <td>K8S_NAMESPACE</td> <td>nfd-master and nfd-worker namespace</td> <td>node-feature-discovery</td> </tr> </tbody> </table></div> <p>For example, to use a custom registry:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make <span class="nv">IMAGE_REGISTRY</span><span class="o">=</span>&lt;my custom registry uri&gt;
</code></pre></div></div> <p>Or to specify a build tool different from Docker, It can be done in 2 ways:</p> <ol> <li> <p>via environment</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">IMAGE_BUILD_CMD</span><span class="o">=</span><span class="s2">"buildah bud"</span> make
</code></pre></div> </div> </li> <li> <p>by overriding the variable value</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> make  <span class="nv">IMAGE_BUILD_CMD</span><span class="o">=</span><span class="s2">"buildah bud"</span>
</code></pre></div> </div> </li> </ol> <h3 id="testing"> <a href="#testing" class="anchor-heading" aria-labelledby="testing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Testing </h3> <p>Unit tests are automatically run as part of the container image build. You can also run them manually in the source code tree by running:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make <span class="nb">test</span>
</code></pre></div></div> <p>End-to-end tests are built on top of the e2e test framework of Kubernetes, and, they required a cluster to run them on. For running the tests on your test cluster you need to specify the kubeconfig to be used:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make e2e-test <span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$HOME</span>/.kube/config
</code></pre></div></div> <p>There are several environment variables that can be used to customize the e2e-tests:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Variable</th> <th>Description</th> <th>Default value</th> </tr> </thead> <tbody> <tr> <td>KUBECONFIG</td> <td>Kubeconfig for running e2e-tests</td> <td><em>empty</em></td> </tr> <tr> <td>E2E_TEST_CONFIG</td> <td>Parameterization file of e2e-tests (see <a href="https://github.com/kubernetes-sigs/node-feature-discovery/blob/master/test/e2e/e2e-test-config.exapmle.yaml">example</a>)</td> <td><em>empty</em></td> </tr> <tr> <td>E2E_PULL_IF_NOT_PRESENT</td> <td>True-ish value makes the image pull policy IfNotPresent (to be used only in e2e tests)</td> <td>false</td> </tr> <tr> <td>E2E_TEST_FULL_IMAGE</td> <td>Run e2e-test also against the Full Image tag</td> <td>false</td> </tr> <tr> <td>E2E_GINKGO_LABEL_FILTER</td> <td>Ginkgo label filter to use for running e2e tests</td> <td><em>empty</em></td> </tr> <tr> <td>OPENSHIFT</td> <td>Non-empty value enables OpenShift specific support (only affects e2e tests)</td> <td><em>empty</em></td> </tr> </tbody> </table></div> <h3 id="nfd-master"> <a href="#nfd-master" class="anchor-heading" aria-labelledby="nfd-master"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> NFD-Master </h3> <p>For development and debugging it is possible to run nfd-master as a stand-alone binary outside the cluster. The <code class="language-plaintext highlighter-rouge">-no-publish</code> flag can be used to prevent nfd-master making changes to the nodes. If <code class="language-plaintext highlighter-rouge">-no-publish</code> is not set, nfd-master also requires the <code class="language-plaintext highlighter-rouge">NODE_NAME</code> environment variable to be set for cleaning up stale annotations.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make build
<span class="nv">NODE_NAME</span><span class="o">=</span>&lt;EXISTING_NODE&gt; ./nfd-master <span class="nt">-no-publish</span> <span class="nt">-kubeconfig</span> ~/.kube/config
</code></pre></div></div> <h3 id="nfd-worker"> <a href="#nfd-worker" class="anchor-heading" aria-labelledby="nfd-worker"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> NFD-Worker </h3> <p>For development and debugging it is possible to run nfd-worker as a stand-alone binary outside the cluster. The <code class="language-plaintext highlighter-rouge">-no-publish</code> flag can be used to prevent nfd-worker from creating NodeFeature objects in the target cluster. If the <code class="language-plaintext highlighter-rouge">-no-publish</code> is not set, nfd-worker also requires the <code class="language-plaintext highlighter-rouge">NODE_NAME</code> and <code class="language-plaintext highlighter-rouge">KUBERNETES_NAMESPACE</code> environment variables to be defined to create the NodeFeature object in the target cluster.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make build
<span class="nv">KUBERNETES_NAMESPACE</span><span class="o">=</span>default <span class="nv">NODE_NAME</span><span class="o">=</span>nonexistent-node ./bin/nfd-worker <span class="nt">-kubeconfig</span> ~/.kube/config
</code></pre></div></div> <blockquote> <p><strong>NOTE:</strong> Running nfd-worker locally this way discovers and publishes features of the local development system you’re running nfd-worker on.</p> </blockquote> <h3 id="nfd-topology-updater"> <a href="#nfd-topology-updater" class="anchor-heading" aria-labelledby="nfd-topology-updater"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> NFD-Topology-Updater </h3> <p>For development and debugging it is possible to run nfd-topology-updater as a stand-alone binary outside the cluster. However, it requires access to the kubelet’s local pod-resources socket and the kubelet http api so in practice it needs to be run on a host acting as a Kubernetes node and thus running kubelet. Running kubelet with <code class="language-plaintext highlighter-rouge">--read-only-port=10255</code> (or <code class="language-plaintext highlighter-rouge">readOnlyPort: 10255</code> in config) makes it possible to connect to kubelet without auth-token (never do this in a production cluster). Also, the <code class="language-plaintext highlighter-rouge">-no-publish</code> flag can be used to prevent nfd-topology-updater from creating NodeResourceTopology objects in the target cluster. If the <code class="language-plaintext highlighter-rouge">-no-publish</code> is not set, nfd-topology-updater also requires the <code class="language-plaintext highlighter-rouge">NODE_NAME</code> and <code class="language-plaintext highlighter-rouge">KUBERNETES_NAMESPACE</code> environment variables to be defined.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make build
<span class="nv">KUBERNETES_NAMESPACE</span><span class="o">=</span>default <span class="nv">NODE_NAME</span><span class="o">=</span>nonexistent-node ./bin/nfd-topology-updater <span class="nt">-kubeconfig</span> ~/.kube/config <span class="nt">-kubelet-config-uri</span> http://127.0.0.1:10255
</code></pre></div></div> <h2 id="running-with-tilt"> <a href="#running-with-tilt" class="anchor-heading" aria-labelledby="running-with-tilt"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running with Tilt </h2> <p>Another option for building NFD locally is via Tilt tool, which can build container images, push them to a local registry and reload your Kubernetes pods automatically. When using Tilt, you don’t have to build container images and re-deploy your pods manually but instead let the Tilt take care of it. Tiltfile is a configuration file for the Tilt and is located at the root directory. To develop NFD with Tilt, follow the steps below.</p> <h3 id="prerequisites"> <a href="#prerequisites" class="anchor-heading" aria-labelledby="prerequisites"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prerequisites </h3> <ol> <li>Install <a href="https://docs.docker.com/engine/install/">Docker</a></li> <li>Setup Docker as a non-root user.</li> <li>Install <a href="https://kubernetes.io/docs/tasks/tools/">kubectl</a></li> <li>Install <a href="https://github.com/kubernetes-sigs/kustomize">kustomize</a></li> <li>Install <a href="https://docs.tilt.dev/install.html">tilt</a></li> <li>Create a local Kubernetes cluster <ul> <li>Create image registry first</li> <li>Create a Kubernetes cluster. Please note that docker containers will be served as controller node and worker nodes, and NFD-worker will run as a DaemonSet in nested container. Therefore, to make sure the NFD-worker can discover the host features, the host folders “/boot” and “/lib” should be mounted into worker node docker containers when creating the Kubernetes cluster.</li> </ul> </li> <li> <p>Start up node feature discovery development environment To start up your Tilt development environment, run at the root of your local NFD codebase.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> tilt up
</code></pre></div> </div> <p>Tilt will start a web interface in the localhost and port 10350. From the web interface, you are able to see how NFD worker and master are progressing, watch their build and runtime logs. Once your code changes are saved locally, Tilt will notice it and re-build the container image from the current code, push the image to the registry and re-deploy NFD pods with the latest container image.</p> </li> </ol> <h3 id="environment-variables"> <a href="#environment-variables" class="anchor-heading" aria-labelledby="environment-variables"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Environment variables </h3> <p>To override environment variables used in the Tiltfile during image build, export them in your current terminal before starting Tilt.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">IMAGE_TAG_NAME</span><span class="o">=</span><span class="s2">"v1"</span>
tilt up
</code></pre></div></div> <p>This will override the default value(<code class="language-plaintext highlighter-rouge">master</code>) of <code class="language-plaintext highlighter-rouge">IMAGE_TAG_NAME</code> variable defined in the Tiltfile.</p> <h2 id="documentation"> <a href="#documentation" class="anchor-heading" aria-labelledby="documentation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Documentation </h2> <p>All documentation resides under the <a href="https://github.com/kubernetes-sigs/node-feature-discovery/tree/master/docs">docs</a> directory in the source tree. It is designed to be served as a html site by <a href="https://pages.github.com/">GitHub Pages</a>.</p> <p>Building the documentation is containerized to fix the build environment. The recommended way for developing documentation is to run:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make site-serve
</code></pre></div></div> <p>This will build the documentation in a container and serve it under <a href="http://localhost:4000/">localhost:4000/</a> making it easy to verify the results. Any changes made to the <code class="language-plaintext highlighter-rouge">docs/</code> will automatically re-trigger a rebuild and are reflected in the served content and can be inspected with a browser refresh.</p> <p>To just build the html documentation run:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make site-build
</code></pre></div></div> <p>This will generate html documentation under <code class="language-plaintext highlighter-rouge">docs/_site/</code>.</p> <!-- Links --> </main> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
